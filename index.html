<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spirit Halloween Meme Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#121212; color:#eee; text-align:center; padding:20px; }
    h1 { color:#ff9900; margin-bottom:10px; }
    #memeCanvas { border:2px solid #444; margin-top:16px; background:#fff; max-width:100%; height:auto; }
    input, #offsetSlider {
      margin:6px; padding:6px; border-radius:4px; border:1px solid #333;
      background:#1e1e1e; color:#eee;
    }
    #offsetSlider { width: 300px; }
    .hint { color:#aaa; font-size:13px; margin-top:8px; }
    label { display:block; margin-top:10px; }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      background: #ff9900;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <h1>üéÉ Spirit Halloween Meme Generator</h1>

  <div>
    <label>Costume Title:</label>
    <input id="title" value="Guy Who Asks for WiFi Password" />

    <label>Details (comma-separated):</label>
    <input id="details" size="60" value="Includes: hoodie, laptop, bad vibes" />

    <label>Upload Costume Image:</label>
    <input type="file" id="upload" accept="image/*" />

    <label>Adjust Horizontal Offset:</label>
    <input type="range" id="offsetSlider" min="-100" max="100" value="30" />
    <span id="offsetValue">30</span> px
  </div>

  <canvas id="memeCanvas" width="800" height="1200"></canvas>

  <div>
    <button id="saveBtn">Save / Open Meme</button>
  </div>

  <p class="hint">üíæ Desktop: downloads directly. Mobile: opens in a new tab so you can long-press ‚Üí ‚ÄúSave Image‚Äù.</p>

  <script>
    const canvas = document.getElementById("memeCanvas");
    const ctx = canvas.getContext("2d");

    const titleInput   = document.getElementById("title");
    const detailsInput = document.getElementById("details");
    const uploadInput  = document.getElementById("upload");
    const offsetSlider = document.getElementById("offsetSlider");
    const offsetValue  = document.getElementById("offsetValue");
    const saveBtn      = document.getElementById("saveBtn");

    const template = new Image();
    let templateLoaded = false;
    let userImage = null;
    let offsetXAdjustment = parseInt(offsetSlider.value, 10);

    template.onload = () => { templateLoaded = true; draw(); };
    template.onerror = () => {
      ctx.fillStyle = "#ffcc00";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "36px Arial";
      ctx.fillText("‚ö†Ô∏è Missing spirit1-mask.png", 150, 600);
    };
    // Your cutout PNG with transparent oval (same folder as this file)
    template.src = "spirit1-mask.png";

    uploadInput.addEventListener("change", e => {
      const file = e.target.files?.[0];
      if (!file) { userImage = null; draw(); return; }
      const reader = new FileReader();
      reader.onload = evt => {
        userImage = new Image();
        userImage.onload = draw;
        userImage.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    titleInput.addEventListener("input", draw);
    detailsInput.addEventListener("input", draw);

    offsetSlider.addEventListener("input", () => {
      offsetXAdjustment = parseInt(offsetSlider.value, 10);
      offsetValue.textContent = offsetXAdjustment;
      draw();
    });

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 1) User photo scaled/centered in the oval bounding box (+ adjustable horizontal nudge)
      if (userImage) {
        const ovalX = 420, ovalY = 180, ovalW = 330, ovalH = 600;

        const scale = Math.max(ovalW / userImage.width, ovalH / userImage.height);
        const newW = userImage.width * scale;
        const newH = userImage.height * scale;

        const offX = ovalX + (ovalW - newW) / 2 + offsetXAdjustment;
        const offY = ovalY + (ovalH - newH) / 2;

        ctx.drawImage(userImage, offX, offY, newW, newH);
      }

      // 2) Draw the mask/template over it
      if (templateLoaded) {
        ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
      }

      // 3) Title & details on top
      const title = titleInput.value.trim();
      if (title) {
        ctx.font = "bold 32px Arial";
        ctx.fillStyle = "#000";
        wrapText(ctx, title, 40, 280, 320, 36);
      }

      const detRaw = detailsInput.value.trim();
      if (detRaw) {
        ctx.font = "20px Arial";
        ctx.fillStyle = "#000";
        let y = 650;
        detRaw.split(",").map(s => s.trim()).filter(Boolean).forEach(txt => {
          wrapText(ctx, "‚Ä¢ " + txt, 40, y, 320, 28);
          y += 36;
        });
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(" ");
      let line = "";
      for (let i = 0; i < words.length; i++) {
        const test = line + words[i] + " ";
        if (ctx.measureText(test).width > maxWidth && i > 0) {
          ctx.fillText(line, x, y);
          line = words[i] + " ";
          y += lineHeight;
        } else {
          line = test;
        }
      }
      ctx.fillText(line, x, y);
    }

    // --- Cross-platform save/open (mobile friendly) ---
    saveBtn.addEventListener("click", saveMeme);

    function saveMeme() {
      draw(); // ensure latest

      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      // OPEN A TAB *IMMEDIATELY* (so mobile won't block it)
      let tabRef = null;
      if (isMobile) {
        tabRef = window.open("about:blank", "_blank");
        if (!tabRef) {
          alert("Please allow pop-ups to save the image.");
          return;
        }
        // basic skeleton so user doesn't see a blank page
        tabRef.document.title = "Spirit Meme";
        tabRef.document.body.style = "margin:0;background:#000;display:flex;align-items:center;justify-content:center;";
        tabRef.document.body.innerHTML = "<div style='color:#fff;font:16px Arial'>Preparing image‚Ä¶</div>";
      }

      try {
        canvas.toBlob(function(blob) {
          if (!blob) {
            // Rare fallback: use dataURL if toBlob not available
            const dataUrl = canvas.toDataURL("image/png");
            if (isMobile) {
              tabRef.location.href = dataUrl;
            } else {
              const a = document.createElement("a");
              a.href = dataUrl;
              a.download = "spirit-meme.png";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
            return;
          }

          const url = URL.createObjectURL(blob);

          if (isMobile) {
            // Render the image inside the already-opened tab (reliable on iOS/Android)
            tabRef.document.body.innerHTML =
              "<img id='memeOut' alt='meme' style='width:100%;height:auto;display:block' />";
            const img = tabRef.document.getElementById("memeOut");
            img.src = url;
            // don't revoke immediately; let user save. You can clean up when tab closes.
          } else {
            // Desktop: direct download
            const a = document.createElement("a");
            a.href = url;
            a.download = "spirit-meme.png";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1500);
          }
        }, "image/png");
      } catch (e) {
        // Very defensive fallback
        const dataUrl = canvas.toDataURL("image/png");
        if (isMobile && tabRef) {
          tabRef.location.href = dataUrl;
        } else {
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = "spirit-meme.png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      }
    }

    // Initial draw
    draw();
  </script>
</body>
</html>
