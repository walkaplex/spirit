<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spirit Halloween Meme Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#121212; color:#eee; text-align:center; padding:20px; }
    h1 { color:#ff9900; margin-bottom:10px; }
    #memeCanvas { border:2px solid #444; margin-top:16px; background:#fff; max-width:100%; height:auto; }
    input, #offsetSlider {
      margin:6px; padding:6px; border-radius:4px; border:1px solid #333;
      background:#1e1e1e; color:#eee;
    }
    #offsetSlider { width: 300px; }
    .hint { color:#aaa; font-size:13px; margin-top:8px; }
    label { display:block; margin-top:10px; }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      background: #ff9900;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <h1>🎃 Spirit Halloween Meme Generator</h1>

  <div>
    <label>Costume Title:</label>
    <input id="title" value="Guy Who Asks for WiFi Password" />

    <label>Details (comma-separated):</label>
    <input id="details" size="60" value="Includes: hoodie, laptop, bad vibes" />

    <label>Upload Costume Image:</label>
    <input type="file" id="upload" accept="image/*" />

    <label>Adjust Horizontal Offset:</label>
    <input type="range" id="offsetSlider" min="-100" max="100" value="30" />
    <span id="offsetValue">30</span> px
  </div>

  <canvas id="memeCanvas" width="800" height="1200"></canvas>

  <div>
    <button onclick="saveMeme()">Save / Open Meme</button>
  </div>

  <p class="hint">💾 Desktop: downloads directly. Mobile: opens image in new tab (long-press → Save Image).</p>

  <script>
    const canvas = document.getElementById("memeCanvas");
    const ctx = canvas.getContext("2d");

    const titleInput = document.getElementById("title");
    const detailsInput = document.getElementById("details");
    const uploadInput = document.getElementById("upload");
    const offsetSlider = document.getElementById("offsetSlider");
    const offsetValue = document.getElementById("offsetValue");

    const template = new Image();
    let templateLoaded = false;
    let userImage = null;

    let offsetXAdjustment = parseInt(offsetSlider.value, 10);

    template.onload = () => { templateLoaded = true; draw(); };
    template.onerror = () => {
      ctx.fillStyle = "#ffcc00";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "36px Arial";
      ctx.fillText("⚠️ Missing spirit1-mask.png", 150, 600);
    };
    template.src = "spirit1-mask.png";  // cutout PNG with transparent oval

    uploadInput.addEventListener("change", e => {
      const file = e.target.files?.[0];
      if (!file) { userImage = null; draw(); return; }
      const reader = new FileReader();
      reader.onload = evt => {
        userImage = new Image();
        userImage.onload = draw;
        userImage.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    titleInput.addEventListener("input", draw);
    detailsInput.addEventListener("input", draw);

    offsetSlider.addEventListener("input", () => {
      offsetXAdjustment = parseInt(offsetSlider.value, 10);
      offsetValue.textContent = offsetXAdjustment;
      draw();
    });

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // --- Draw user photo scaled to the oval area ---
      if (userImage) {
        const ovalX = 420, ovalY = 180, ovalW = 330, ovalH = 600;

        const scale = Math.max(ovalW / userImage.width, ovalH / userImage.height);
        const newW = userImage.width * scale;
        const newH = userImage.height * scale;

        const offX = ovalX + (ovalW - newW) / 2 + offsetXAdjustment;
        const offY = ovalY + (ovalH - newH) / 2;

        ctx.drawImage(userImage, offX, offY, newW, newH);
      }

      // --- Draw template cutout on top ---
      if (templateLoaded) {
        ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
      }

      // --- Title ---
      const title = titleInput.value.trim();
      if (title) {
        ctx.font = "bold 32px Arial";
        ctx.fillStyle = "#000";
        wrapText(ctx, title, 40, 280, 320, 36);
      }

      // --- Details ---
      const detRaw = detailsInput.value.trim();
      if (detRaw) {
        ctx.font = "20px Arial";
        ctx.fillStyle = "#000";
        let y = 650;
        detRaw.split(",").map(s => s.trim()).filter(Boolean).forEach(txt => {
          wrapText(ctx, "• " + txt, 40, y, 320, 28);
          y += 36;
        });
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(" ");
      let line = "";
      for (let i = 0; i < words.length; i++) {
        const test = line + words[i] + " ";
        if (ctx.measureText(test).width > maxWidth && i > 0) {
          ctx.fillText(line, x, y);
          line = words[i] + " ";
          y += lineHeight;
        } else {
          line = test;
        }
      }
      ctx.fillText(line, x, y);
    }

    function saveMeme() {
      draw(); // refresh before saving

      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        const link = document.createElement("a");
        link.href = url;
        link.download = "spirit-meme.png";

        if (isMobile) {
          // Mobile: open in new tab (long-press to save)
          link.target = "_blank";
        }

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // cleanup
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }, "image/png");
    }

    draw();
  </script>
</body>
</html>
